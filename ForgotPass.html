<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forget Password | Intelli-Read</title>
  <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="ForgotPass.css">
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
</head>
<body>

  <!-- ===== HEADER ===== -->
  <header>
    <a href="/Home.html"><img src="/images/logo.png" alt="Intelli-Read Logo" style="height:80px; width:auto;"></a>
    <div class="nav-buttons"></div>
  </header>

  <!-- main -->
  <div class="login-container">
    <div class="login-card">
      <h2>Forget Password</h2>
      <p class="subtitle">Enter your email to reset your password ðŸ”“</p>
      <form class="login-form" id="loginForm">
        
        <!-- Email input with Send OTP button -->
        <div class="email-otp-container">
          <div class="email-input-group input-group">
            <i class="bx bx-envelope"></i>
            <input type="email" id="email" name="email" placeholder="Enter your email" required>
          </div>
          <button type="button" id="sendOtpBtn">Send OTP</button>
        </div>

        <!-- OTP verification -->
        <div class="otp-container">
          <label class="otp-label">Enter OTP :</label>
          <div class="otp-group" data-expected="">
            <input class="otp-input" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="OTP digit 1" />
            <input class="otp-input" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="OTP digit 2" />
            <input class="otp-input" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="OTP digit 3" />
            <input class="otp-input" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="OTP digit 4" />
            
            <!-- OTP actions in the same line as OTP boxes -->
            <div class="otp-actions">
              <button type="button" id="verifyBtn">Verify</button>
              <div class="resend-container">
                <span class="resend-otp" id="resendOtp">Resend OTP</span>
                <span class="timer" id="timer">(02:00)</span>
              </div>
            </div>
          </div>
          <input type="hidden" id="otp" name="otp" required />
        </div>
      
        <!-- Password input -->
        <div class="input-group">
          <i class="bx bx-lock-alt"></i>
          <input type="password" id="password" name="password" placeholder="New Password" required>
          <i class='bx bx-hide toggle-eye' id="togglePassword"></i>
        </div>

        <!-- Confirm Password input -->
        <div class="input-group">
          <i class="bx bx-lock-alt"></i>
          <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm New Password" required>
          <i class='bx bx-hide toggle-eye' id="toggleConfirmPassword"></i>
        </div>

        <button type="submit" class="login-btn">Update Password</button>
        <p class="signup-link">Back to Login  - <a href="/login">Click here</a></p>
      </form>
    </div>
  </div>

  <!-- ===== FOOTER ===== -->
  <footer class="main-footer" style="font-family: chakra petch;">
    <div class="footer-section">
      <h4>About</h4>
      <p>Designed and Developed by Team <b style="color: rgb(206, 232, 10); font-size: large;">Rv</b></p>
    </div>
    <div class="footer-section">
      <p>&copy; <span>2025</span> Intelli-Read. All Rights Reserved.</p>
      <p><a href="#">Terms of Service</a> | <a href="#">Privacy Policy</a></p>
    </div>
    <div class="footer-section">
      <h4>License</h4>
      <p>Standard License</p>
    </div>
  </footer>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // OTP Verification Logic
    const otpContainer = document.querySelector('.otp-container');
    const otpInputs = document.querySelectorAll('.otp-input');
    const hiddenOtp = document.getElementById('otp');
    const verifyBtn = document.getElementById('verifyBtn');
    const resendOtp = document.getElementById('resendOtp');
    const timer = document.getElementById('timer');
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const emailInput = document.getElementById('email');
    const loginForm = document.getElementById('loginForm');
    
    let generatedOtp = '';
    let countdown = 120; // 2 minutes in seconds
    let timerInterval;
    let isOtpVerified = false;

    // Initially disable OTP inputs and verify button
    otpInputs.forEach(input => input.disabled = true);
    verifyBtn.disabled = true;
    resendOtp.classList.add('disabled');
    resendOtp.style.color = '#ccc';
    resendOtp.style.cursor = 'not-allowed';

    // Send OTP button functionality
    sendOtpBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      
      if (!email) {
        alert('Please enter your email address');
        return;
      }
      
      if (!validateEmail(email)) {
        alert('Please enter a valid email address');
        return;
      }
      
      // Show loading state
      sendOtpBtn.disabled = true;
      sendOtpBtn.textContent = 'Sending...';
      
      try {
        const response = await fetch('/api/forgot-password/send-otp', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Store the email for later use
          emailInput.dataset.verified = 'true';
          
          // Enable OTP inputs and verify button
          otpInputs.forEach(input => input.disabled = false);
          verifyBtn.disabled = false;
          
          // Focus the first OTP input
          otpInputs[0].focus();
          
          sendOtpBtn.textContent = 'OTP Sent';
          sendOtpBtn.style.background = '#4caf50';
          
          // Start the timer
          startTimer();
          
          alert(`OTP sent successfully to ${email}`);
        } else {
          alert(data.message || 'Failed to send OTP. Please try again.');
          sendOtpBtn.disabled = false;
          sendOtpBtn.textContent = 'Send OTP';
        }
      } catch (error) {
        console.error('Error sending OTP:', error);
        alert('Failed to send OTP. Please check your connection and try again.');
        sendOtpBtn.disabled = false;
        sendOtpBtn.textContent = 'Send OTP';
      }
    });

    // Start the timer
    function startTimer() {
      countdown = 120;
      updateTimerDisplay();
      
      timerInterval = setInterval(() => {
        countdown--;
        updateTimerDisplay();
        
        if (countdown <= 0) {
          clearInterval(timerInterval);
          timer.textContent = '';
          resendOtp.classList.remove('disabled');
          resendOtp.style.color = '#667eea';
          resendOtp.style.cursor = 'pointer';
        }
      }, 1000);
    }

    // Focus the first OTP input when enabled
    otpInputs[0].addEventListener('focus', () => {
      if (!otpInputs[0].disabled) {
        otpInputs[0].focus();
      }
    });

    // Add event listeners to OTP inputs
    otpInputs.forEach((input, index) => {
      input.addEventListener('input', (e) => {
        const value = e.target.value.replace(/\D/g, '').slice(0, 1);
        e.target.value = value;
        
        if (value) {
          // Add filled class for styling
          input.classList.add('filled');
          
          // Move to next input if available
          if (index < otpInputs.length - 1) {
            otpInputs[index + 1].focus();
          }
        } else {
          input.classList.remove('filled');
        }
        
        updateHiddenOtp();
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace') {
          if (!e.target.value && index > 0) {
            // If current input is empty and backspace is pressed, focus previous input
            otpInputs[index - 1].focus();
          } else if (e.target.value) {
            // If current input has value, clear it
            e.target.value = '';
            input.classList.remove('filled');
            updateHiddenOtp();
          }
        } else if (e.key === 'ArrowLeft' && index > 0) {
          otpInputs[index - 1].focus();
        } else if (e.key === 'ArrowRight' && index < otpInputs.length - 1) {
          otpInputs[index + 1].focus();
        }
      });

      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const pasteData = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g, '');
        
        if (!pasteData) return;
        
        const digits = pasteData.slice(0, otpInputs.length).split('');
        
        otpInputs.forEach((input, i) => {
          if (digits[i]) {
            input.value = digits[i];
            input.classList.add('filled');
          } else {
            input.value = '';
            input.classList.remove('filled');
          }
        });
        
        // Focus the last filled input or the last input
        const lastFilledIndex = Math.min(digits.length, otpInputs.length) - 1;
        otpInputs[lastFilledIndex].focus();
        
        updateHiddenOtp();
      });
    });

    // Update the hidden OTP field
    function updateHiddenOtp() {
      hiddenOtp.value = Array.from(otpInputs).map(input => input.value || '').join('');
      
      // Remove error styling when user starts typing again
      otpInputs.forEach(input => input.classList.remove('error'));
    }

    // Verify OTP
    verifyBtn.addEventListener('click', async () => {
      const enteredOtp = hiddenOtp.value;
      const email = emailInput.value.trim();
      
      if (enteredOtp.length !== 4) {
        showError('Please enter all 4 digits');
        return;
      }

      // Show loading state
      verifyBtn.disabled = true;
      verifyBtn.textContent = 'Verifying...';

      try {
        const response = await fetch('/api/forgot-password/verify-otp', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            email: email,
            otp: enteredOtp
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Show success - update button to green with "Verified" text
          verifyBtn.textContent = 'Verified';
          verifyBtn.classList.add('verified');
          verifyBtn.classList.remove('error');
          verifyBtn.disabled = true;
          verifyBtn.setAttribute('aria-label', 'OTP verified successfully');
          
          // Disable OTP inputs
          otpInputs.forEach(input => {
            input.disabled = true;
            input.classList.add('filled');
          });
          
          // Mark OTP as verified
          isOtpVerified = true;
          
          // Clear timer
          clearInterval(timerInterval);
          timer.textContent = '';
        } else {
          // Show error - update button to red with "Incorrect" text
          verifyBtn.textContent = 'Incorrect';
          verifyBtn.classList.add('error');
          verifyBtn.classList.remove('verified');
          verifyBtn.setAttribute('aria-label', 'Invalid OTP');
          
          // Add error styling to inputs
          otpInputs.forEach(input => {
            input.classList.add('error');
          });
          
          // Shake animation for error
          otpContainer.classList.add('shake');
          setTimeout(() => {
            otpContainer.classList.remove('shake');
          }, 500);
          
          // Reset button after 2 seconds
          setTimeout(() => {
            verifyBtn.textContent = 'Verify';
            verifyBtn.classList.remove('error');
            verifyBtn.disabled = false;
          }, 2000);
        }
      } catch (error) {
        console.error('Error verifying OTP:', error);
        showError('Failed to verify OTP. Please try again.');
        
        // Reset button after 2 seconds
        setTimeout(() => {
          verifyBtn.textContent = 'Verify';
          verifyBtn.classList.remove('error');
          verifyBtn.disabled = false;
        }, 2000);
      }
    });

    // Show error message and styling
    function showError(message) {
      otpInputs.forEach(input => {
        input.classList.add('error');
      });
      
      // Show error state on button
      verifyBtn.textContent = 'Invalid';
      verifyBtn.classList.add('error');
      verifyBtn.setAttribute('aria-label', message);
      
      // Shake animation for error
      otpContainer.classList.add('shake');
      setTimeout(() => {
        otpContainer.classList.remove('shake');
      }, 500);
    }

    // Resend OTP functionality
    resendOtp.addEventListener('click', async () => {
      if (resendOtp.classList.contains('disabled')) return;
      
      const email = emailInput.value.trim();
      
      if (!email) {
        alert('Please enter your email address first');
        return;
      }

      // Show loading state
      resendOtp.textContent = 'Sending...';
      resendOtp.style.cursor = 'not-allowed';

      try {
        const response = await fetch('/api/forgot-password/resend-otp', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Reset OTP inputs
          otpInputs.forEach(input => {
            input.value = '';
            input.disabled = false;
            input.classList.remove('filled', 'error');
          });
          
          // Reset verification button
          verifyBtn.textContent = 'Verify';
          verifyBtn.classList.remove('verified', 'error');
          verifyBtn.disabled = false;
          isOtpVerified = false;
          
          // Focus first input
          otpInputs[0].focus();
          
          // Reset and restart timer
          clearInterval(timerInterval);
          countdown = 120;
          startTimer();
          
          // Disable resend button temporarily
          resendOtp.classList.add('disabled');
          resendOtp.style.color = '#ccc';
          resendOtp.style.cursor = 'not-allowed';
          resendOtp.textContent = 'Resend OTP';
          
          alert('New OTP sent successfully to your email');
          
          // Re-enable after 30 seconds
          setTimeout(() => {
            resendOtp.classList.remove('disabled');
            resendOtp.style.color = '#667eea';
            resendOtp.style.cursor = 'pointer';
          }, 30000);
        } else {
          alert(data.message || 'Failed to resend OTP. Please try again.');
          resendOtp.textContent = 'Resend OTP';
          resendOtp.style.cursor = 'pointer';
        }
      } catch (error) {
        console.error('Error resending OTP:', error);
        alert('Failed to resend OTP. Please check your connection and try again.');
        resendOtp.textContent = 'Resend OTP';
        resendOtp.style.cursor = 'pointer';
      }
    });

    // Timer function
    function updateTimerDisplay() {
      const minutes = Math.floor(countdown / 60);
      const seconds = countdown % 60;
      timer.textContent = `(${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')})`;
    }

    // Email validation function
    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    // ===== Password Toggle Visibility =====
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('password');
    const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    
    togglePassword.addEventListener('click', () => {
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      togglePassword.classList.toggle('bx-hide');
      togglePassword.classList.toggle('bx-show');
    });

    toggleConfirmPassword.addEventListener('click', () => {
      const type = confirmPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      confirmPasswordInput.setAttribute('type', type);
      toggleConfirmPassword.classList.toggle('bx-hide');
      toggleConfirmPassword.classList.toggle('bx-show');
    });

    // ===== Form Submission =====
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const otp = document.getElementById('otp').value;
      
      // Basic validation
      if (!email || !password || !confirmPassword || !otp) {
        alert('Please fill in all fields');
        return;
      }
      
      if (password !== confirmPassword) {
        alert('Passwords do not match');
        return;
      }
      
      if (!isOtpVerified) {
        alert('Please verify your OTP first');
        return;
      }

      // Show loading state
      const submitBtn = loginForm.querySelector('.login-btn');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Updating...';
      submitBtn.disabled = true;

      try {
        const response = await fetch('/api/forgot-password/reset', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            email: email,
            otp: otp,
            newPassword: password
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Show success message
          alert('Password reset successfully! Redirecting to login...');
          
          // Redirect to login page
          setTimeout(() => {
            window.location.href = '/login';
          }, 1500);
        } else {
          alert(data.message || 'Failed to reset password. Please try again.');
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      } catch (error) {
        console.error('Error resetting password:', error);
        alert('Failed to reset password. Please check your connection and try again.');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });
  });
</script>
</body>
</html>